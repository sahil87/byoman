#!/usr/bin/env bash
#
# wt-pr - Create pull request from worktree
#
# Usage: wt-pr [OPTIONS]
#        wt-pr help
#
# Creates a GitHub PR from the current worktree branch

set -euo pipefail

# ============================================================================
# Constants
# ============================================================================

# Exit codes per contracts/cli-interface.md
readonly EXIT_SUCCESS=0
readonly EXIT_GENERAL_ERROR=1
readonly EXIT_INVALID_ARGS=2
readonly EXIT_GIT_ERROR=3

# Colors (disabled if NO_COLOR is set)
if [[ -z "${NO_COLOR:-}" ]]; then
    readonly RED=$'\033[0;31m'
    readonly YELLOW=$'\033[0;33m'
    readonly GREEN=$'\033[0;32m'
    readonly CYAN=$'\033[0;36m'
    readonly BOLD=$'\033[1m'
    readonly RESET=$'\033[0m'
else
    readonly RED=''
    readonly YELLOW=''
    readonly GREEN=''
    readonly CYAN=''
    readonly BOLD=''
    readonly RESET=''
fi

# ============================================================================
# Error Handling (Constitution III compliant - what/why/fix format)
# ============================================================================

error() {
    local what="$1"
    local why="$2"
    local fix="${3:-}"

    echo "${RED}Error:${RESET} $what" >&2
    echo "  ${BOLD}Why:${RESET} $why" >&2
    if [[ -n "$fix" ]]; then
        echo "  ${BOLD}Fix:${RESET} $fix" >&2
    fi
    exit "$EXIT_GENERAL_ERROR"
}

error_with_code() {
    local code="$1"
    local what="$2"
    local why="$3"
    local fix="${4:-}"

    echo "${RED}Error:${RESET} $what" >&2
    echo "  ${BOLD}Why:${RESET} $why" >&2
    if [[ -n "$fix" ]]; then
        echo "  ${BOLD}Fix:${RESET} $fix" >&2
    fi
    exit "$code"
}

# ============================================================================
# Menu Helper
# ============================================================================

show_menu() {
    local prompt="$1"
    shift
    local options=("$@")

    echo "$prompt"
    local i=1
    for opt in "${options[@]}"; do
        echo "  ${BOLD}$i)${RESET} $opt"
        ((i++))
    done
    echo "  ${BOLD}0)${RESET} Cancel"
    echo ""

    while true; do
        printf "Choice: "
        read -r choice

        if [[ -z "$choice" ]]; then
            MENU_CHOICE=0
            return 0
        fi

        if ! [[ "$choice" =~ ^[0-9]+$ ]]; then
            echo "Invalid choice. Please enter a number."
            continue
        fi

        if ((choice < 0 || choice > ${#options[@]})); then
            echo "Invalid choice. Please enter a number between 0 and ${#options[@]}."
            continue
        fi

        MENU_CHOICE="$choice"
        return 0
    done
}

# ============================================================================
# Git Repository Detection
# ============================================================================

validate_git_repo() {
    if ! git rev-parse --is-inside-work-tree &>/dev/null; then
        error_with_code "$EXIT_GENERAL_ERROR" \
            "Not a git repository" \
            "wt-pr requires a git repository" \
            "Navigate to a git repository and try again"
    fi
}

get_default_branch() {
    local default_branch

    default_branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')

    if [[ -z "$default_branch" ]]; then
        if git show-ref --verify --quiet refs/heads/main 2>/dev/null; then
            default_branch="main"
        elif git show-ref --verify --quiet refs/heads/master 2>/dev/null; then
            default_branch="master"
        else
            default_branch="main"
        fi
    fi

    echo "$default_branch"
}

# ============================================================================
# Cross-Platform Helpers
# ============================================================================

detect_os() {
    case "$(uname -s)" in
        Darwin) echo "macos" ;;
        Linux)  echo "linux" ;;
        *)      echo "unknown" ;;
    esac
}

# Open URL in default browser
open_url() {
    local url="$1"
    local os
    os=$(detect_os)

    case "$os" in
        macos)
            open "$url"
            ;;
        linux)
            xdg-open "$url" &>/dev/null &
            ;;
        *)
            echo "Please open: $url"
            ;;
    esac
}

# ============================================================================
# GitHub CLI Detection
# ============================================================================

# Check if gh CLI is available and authenticated
has_gh_cli() {
    command -v gh &>/dev/null && gh auth status &>/dev/null
}

# ============================================================================
# Branch and PR Detection
# ============================================================================

# Get current branch name
get_current_branch() {
    git rev-parse --abbrev-ref HEAD 2>/dev/null
}

# Check if branch has commits ahead of base
# Args: $1 = base branch
has_commits_ahead() {
    local base="$1"
    local count
    count=$(git rev-list --count "origin/${base}..HEAD" 2>/dev/null || echo "0")
    [[ "$count" -gt 0 ]]
}

# Get commit count ahead of base
# Args: $1 = base branch
get_commit_count() {
    local base="$1"
    git rev-list --count "origin/${base}..HEAD" 2>/dev/null || echo "0"
}

# Check if PR already exists for current branch
# Returns: PR URL if exists, empty otherwise
get_existing_pr() {
    if ! has_gh_cli; then
        return 1
    fi

    gh pr view --json url,state,title,number,isDraft --jq '"\(.number)\t\(.title)\t\(.state)\t\(.isDraft)\t\(.url)"' 2>/dev/null
}

# Check if branch is pushed to remote
branch_is_pushed() {
    local branch="$1"
    git ls-remote --heads origin "$branch" 2>/dev/null | grep -q "$branch"
}

# ============================================================================
# Change Summary Display
# ============================================================================

# Display change summary before PR creation
show_change_summary() {
    local base_branch="$1"
    local current_branch="$2"

    echo "${BOLD}Changes to be included in PR:${RESET}"
    echo ""
    echo "Branch: ${CYAN}$current_branch${RESET} -> ${CYAN}$base_branch${RESET}"

    local commit_count
    commit_count=$(get_commit_count "$base_branch")
    echo "Commits: ${BOLD}$commit_count${RESET}"

    # Show commit list
    git log --oneline "origin/${base_branch}..HEAD" 2>/dev/null | head -10 | sed 's/^/  /'
    if [[ "$commit_count" -gt 10 ]]; then
        echo "  ... and $((commit_count - 10)) more"
    fi
    echo ""

    # Show file stats
    echo "Files:"
    git diff --shortstat "origin/${base_branch}...HEAD" 2>/dev/null | sed 's/^ /  /'
    git diff --stat "origin/${base_branch}...HEAD" 2>/dev/null | tail -n +1 | head -10 | sed 's/^/  /'
    echo ""
}

# ============================================================================
# PR Creation
# ============================================================================

# Build GitHub PR URL for browser fallback
build_pr_url() {
    local base_branch="$1"
    local current_branch="$2"

    local remote_url
    remote_url=$(git remote get-url origin 2>/dev/null)

    # Convert SSH to HTTPS
    local repo_url
    repo_url=$(echo "$remote_url" | sed -e 's|git@github.com:|https://github.com/|' -e 's|\.git$||')

    echo "${repo_url}/compare/${base_branch}...${current_branch}?expand=1"
}

# Push branch to remote
push_branch() {
    local branch="$1"
    echo "Pushing branch ${BOLD}$branch${RESET} to origin..."
    if ! git push -u origin "$branch" 2>/dev/null; then
        error_with_code "$EXIT_GIT_ERROR" \
            "Failed to push branch" \
            "git push to origin failed" \
            "Check your network connection and permissions"
    fi
}

# Create PR using gh CLI
# Args: $1 = draft (true/false)
create_pr_with_gh() {
    local draft="$1"
    local draft_flag=""

    if [[ "$draft" == "true" ]]; then
        draft_flag="--draft"
        echo "Creating draft PR..."
    else
        echo "Creating PR..."
    fi

    local pr_url
    # shellcheck disable=SC2086
    pr_url=$(gh pr create $draft_flag --fill 2>&1) || {
        error_with_code "$EXIT_GIT_ERROR" \
            "Failed to create PR" \
            "gh pr create failed" \
            "Check if you have permission to create PRs in this repository"
    }

    echo ""
    echo "PR created: ${GREEN}$pr_url${RESET}"
    echo "$pr_url"
}

# Create PR via browser
create_pr_via_browser() {
    local base_branch="$1"
    local current_branch="$2"

    echo ""
    echo "${YELLOW}Note:${RESET} gh CLI not found, opening browser for PR creation"
    echo ""

    local pr_url
    pr_url=$(build_pr_url "$base_branch" "$current_branch")

    echo "Opening: ${CYAN}$pr_url${RESET}"
    open_url "$pr_url"
}

# Handle existing PR
handle_existing_pr() {
    local pr_info="$1"

    local pr_number pr_title pr_state pr_draft pr_url
    pr_number=$(echo "$pr_info" | cut -f1)
    pr_title=$(echo "$pr_info" | cut -f2)
    pr_state=$(echo "$pr_info" | cut -f3)
    pr_draft=$(echo "$pr_info" | cut -f4)
    pr_url=$(echo "$pr_info" | cut -f5)

    echo "PR already exists for this branch:"
    echo ""
    echo "  #${BOLD}$pr_number${RESET}: $pr_title"
    echo "  Status: $pr_state$([ "$pr_draft" = "true" ] && echo " (Draft)")"
    echo "  URL: ${CYAN}$pr_url${RESET}"
    echo ""

    local options=("Open in browser")
    if [[ "$pr_draft" == "true" ]]; then
        options+=("Mark as ready")
    fi

    show_menu "What would you like to do?" "${options[@]}"

    case "$MENU_CHOICE" in
        1)
            open_url "$pr_url"
            ;;
        2)
            if [[ "$pr_draft" == "true" ]]; then
                echo "Marking PR as ready..."
                gh pr ready 2>/dev/null && echo "PR marked as ready for review."
            fi
            ;;
        0)
            exit "$EXIT_SUCCESS"
            ;;
    esac
}

# Main PR creation flow
create_pr_interactive() {
    local base_branch current_branch
    base_branch=$(get_default_branch)
    current_branch=$(get_current_branch)

    # Check for existing PR
    local existing_pr
    existing_pr=$(get_existing_pr 2>/dev/null) || true
    if [[ -n "$existing_pr" ]]; then
        handle_existing_pr "$existing_pr"
        exit "$EXIT_SUCCESS"
    fi

    # Check for commits
    if ! has_commits_ahead "$base_branch"; then
        error "No changes to create PR" \
            "Branch $current_branch has no commits ahead of $base_branch" \
            "Make some commits first, then run wt-pr"
    fi

    # Show change summary
    show_change_summary "$base_branch" "$current_branch"

    # Show menu
    show_menu "Create PR:" \
        "Draft PR" \
        "Ready PR" \
        "Just push (no PR)"

    case "$MENU_CHOICE" in
        1|2|3)
            # Push if needed
            if ! branch_is_pushed "$current_branch"; then
                push_branch "$current_branch"
            fi
            ;;
        0)
            echo "Cancelled."
            exit "$EXIT_SUCCESS"
            ;;
    esac

    case "$MENU_CHOICE" in
        1)
            # Draft PR
            if has_gh_cli; then
                local url
                url=$(create_pr_with_gh "true")
                offer_open_in_browser "$url"
            else
                create_pr_via_browser "$base_branch" "$current_branch"
            fi
            ;;
        2)
            # Ready PR
            if has_gh_cli; then
                local url
                url=$(create_pr_with_gh "false")
                offer_open_in_browser "$url"
            else
                create_pr_via_browser "$base_branch" "$current_branch"
            fi
            ;;
        3)
            # Just push
            echo "Branch pushed. No PR created."
            ;;
    esac
}

# Offer to open PR in browser
offer_open_in_browser() {
    local url="$1"

    # Extract URL if output contains more than just URL
    url=$(echo "$url" | grep -oE 'https://github.com/[^ ]+' | tail -1)

    if [[ -z "$url" ]]; then
        return
    fi

    echo ""
    show_menu "Open in browser?" \
        "Yes"

    if [[ "$MENU_CHOICE" == "1" ]]; then
        open_url "$url"
    fi
}

# Non-interactive PR creation
create_pr_noninteractive() {
    local mode="$1"  # draft, ready, or push
    local no_summary="${2:-}"

    local base_branch current_branch
    base_branch=$(get_default_branch)
    current_branch=$(get_current_branch)

    # Check for existing PR (for draft/ready modes)
    if [[ "$mode" != "push" ]]; then
        local existing_pr
        existing_pr=$(get_existing_pr 2>/dev/null) || true
        if [[ -n "$existing_pr" ]]; then
            local pr_url
            pr_url=$(echo "$existing_pr" | cut -f5)
            echo "PR already exists: $pr_url"
            exit "$EXIT_SUCCESS"
        fi
    fi

    # Check for commits
    if ! has_commits_ahead "$base_branch"; then
        error "No changes to create PR" \
            "Branch $current_branch has no commits ahead of $base_branch" \
            "Make some commits first, then run wt-pr"
    fi

    # Show summary unless --no-summary
    if [[ "$no_summary" != "true" ]]; then
        show_change_summary "$base_branch" "$current_branch"
    fi

    # Push if needed
    if ! branch_is_pushed "$current_branch"; then
        push_branch "$current_branch"
    fi

    case "$mode" in
        draft)
            if has_gh_cli; then
                create_pr_with_gh "true"
            else
                create_pr_via_browser "$base_branch" "$current_branch"
            fi
            ;;
        ready)
            if has_gh_cli; then
                create_pr_with_gh "false"
            else
                create_pr_via_browser "$base_branch" "$current_branch"
            fi
            ;;
        push)
            echo "Branch pushed."
            ;;
    esac
}

# ============================================================================
# Help
# ============================================================================

show_help() {
    cat <<EOF
Usage: wt-pr [OPTIONS]
       wt-pr help

Creates a GitHub pull request from the current branch.

Options:
  --draft, -d       Create draft PR without menu (non-interactive)
  --ready, -r       Create ready PR without menu (non-interactive)
  --push, -p        Just push branch without creating PR
  --no-summary      Skip change summary display
  help              Show this help message

Exit Codes:
  0    Success
  1    General error
  2    Invalid arguments
  3    Git/GitHub operation failed

Examples:
  wt-pr              # Interactive PR creation
  wt-pr --draft      # Create draft PR immediately
  wt-pr --ready      # Create ready PR immediately
  wt-pr --push       # Push without creating PR

Environment:
  NO_COLOR           Suppress colored output
  BROWSER            Override default browser for URL opening
EOF
}

# ============================================================================
# Main Entry Point
# ============================================================================

main() {
    local mode=""
    local no_summary=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            help|--help|-h)
                show_help
                exit "$EXIT_SUCCESS"
                ;;
            --draft|-d)
                mode="draft"
                shift
                ;;
            --ready|-r)
                mode="ready"
                shift
                ;;
            --push|-p)
                mode="push"
                shift
                ;;
            --no-summary)
                no_summary="true"
                shift
                ;;
            -*)
                error_with_code "$EXIT_INVALID_ARGS" \
                    "Unknown option: $1" \
                    "This option is not recognized" \
                    "Run 'wt-pr help' for usage information"
                ;;
            *)
                error_with_code "$EXIT_INVALID_ARGS" \
                    "Unexpected argument: $1" \
                    "wt-pr does not take positional arguments" \
                    "Run 'wt-pr help' for usage information"
                ;;
        esac
    done

    validate_git_repo

    if [[ -n "$mode" ]]; then
        create_pr_noninteractive "$mode" "$no_summary"
    else
        create_pr_interactive
    fi
}

main "$@"
